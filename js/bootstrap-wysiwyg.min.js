/* @fileoverview 
 * Provides full Bootstrap based, multi-instance WYSIWYG editor. 
 * 
 * Name     = bootstrap-wysiwyg 
 * Author   = Various, see LICENCE 
 * Version  = v1.0.3-rc 
 * About    = A tiny Bootstrap and jQuery based WYSIWYG rich text editor based on the browser function execCommand. 
*/ 

!function(a){"use strict";var b=function(a,b){var c,d,e,f,g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)};return function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},c=function(b){var c=a.Deferred(),d=new FileReader;return d.onload=function(a){c.resolve(a.target.result)},d.onerror=c.reject,d.onprogress=c.notify,d.readAsDataURL(b),c.promise()};a.fn.cleanHtml=function(b){if(a(this).data("wysiwyg-html-mode")===!0&&(a(this).html(a(this).text()),a(this).attr("contenteditable",!0),a(this).data("wysiwyg-html-mode",!1)),b===!0&&a(this).parent().is("form")){var c=a(this).html;if(a(c).has("img").length){var d=a("img",a(c)),e=[],f=a(this).parent();a.each(d,function(b,c){a(c).attr("src").match(/^data:image\/.*$/)&&(e.push(d[b]),a(f).prepend("<input value='"+a(c).attr("src")+"' type='hidden' name='postedimage/"+b+"' />"),a(c).attr("src","postedimage/"+b))})}}var g=a(this).html();return g&&g.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},a.fn.wysiwyg=function(d){var e,f,g,h=this,i=a(h).parent(),j=function(){f.activeToolbarClass&&a(f.toolbarSelector,i).find(g).each(b(function(){var b=a(this).data(f.commandRole).split(" "),c=b[0];b.length>1&&document.queryCommandEnabled(c)&&document.queryCommandValue(c)===b[1]?a(this).addClass(f.activeToolbarClass):1===b.length&&document.queryCommandEnabled(c)&&document.queryCommandState(c)?a(this).addClass(f.activeToolbarClass):a(this).removeClass(f.activeToolbarClass)},f.keypressTimeout))},k=function(a,b){var c=a.split(" "),d=c.shift(),e=c.join(" ")+(b||""),f=a.split("-");1===f.length?document.execCommand(d,0,e):"format"===f[0]&&2===f.length&&document.execCommand("formatBlock",!1,f[1]),h.trigger("change"),j()},l=function(b){a.each(b,function(a,b){h.keydown(a,function(a){h.attr("contenteditable")&&h.is(":visible")&&(a.preventDefault(),a.stopPropagation(),k(b))}).keyup(a,function(a){h.attr("contenteditable")&&h.is(":visible")&&(a.preventDefault(),a.stopPropagation())})}),h.keyup(function(){h.trigger("change")})},m=function(){var a,b;return window.getSelection?(a=window.getSelection(),a.getRangeAt&&a.rangeCount&&(b=a.getRangeAt(0))):document.selection&&(b=document.selection.createRange()),b},n=function(){e=m()},o=function(){var a;if(window.getSelection||document.createRange){if(a=window.getSelection(),e){try{a.removeAllRanges()}catch(b){document.body.createTextRange().select(),document.selection.empty()}a.addRange(e)}}else document.selection&&e&&e.select()},p=function(){if(a(h).data("wysiwyg-html-mode")!==!0){var b=a(h).html(),c=a("<pre />");a(c).append(document.createTextNode(b)),a(c).attr("contenteditable",!0),a(h).html(" "),a(h).append(a(c)),a(h).attr("contenteditable",!1),a(h).data("wysiwyg-html-mode",!0),a(c).focus()}else a(h).html(a(h).text()),a(h).attr("contenteditable",!0),a(h).data("wysiwyg-html-mode",!1),a(h).focus()},q=function(b){h.focus(),a.each(b,function(b,d){/^image\//.test(d.type)?a.when(c(d)).done(function(a){k("insertimage",a),h.trigger("image-inserted")}).fail(function(a){f.fileUploadError("file-reader",a)}):f.fileUploadError("unsupported-file-type",d.type)})},r=function(a,b){o(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",0,b||"transparent"),n(),a.data(f.selectionMarker,b)},s=function(b,c){b.find(g,i).click(function(){o(),h.focus(),"html"===a(this).data(c.commandRole)?p():k(a(this).data(c.commandRole)),n()}),b.find("[data-toggle=dropdown]").click(o),b.find("input[type=text][data-"+c.commandRole+"]").on("webkitspeechchange change",function(){var b=this.value;this.value="",o(),b&&(h.focus(),k(a(this).data(c.commandRole),b)),n()}).on("focus",function(){var b=a(this);b.data(c.selectionMarker)||(r(b,c.selectionColor),b.focus())}).on("blur",function(){var b=a(this);b.data(c.selectionMarker)&&r(b,!1)}),b.find("input[type=file][data-"+c.commandRole+"]").change(function(){o(),"file"===this.type&&this.files&&this.files.length>0&&q(this.files),n(),this.value=""})},t=function(){h.on("dragenter dragover",!1).on("drop",function(a){var b=a.originalEvent.dataTransfer;a.stopPropagation(),a.preventDefault(),b&&b.files&&b.files.length>0&&q(b.files)})};return f=a.extend(!0,{},a.fn.wysiwyg.defaults,d),g="a[data-"+f.commandRole+"],button[data-"+f.commandRole+"],input[type=button][data-"+f.commandRole+"]",l(f.hotKeys),""!==a(this).attr("placeholder")&&(a(this).addClass("placeholderText"),a(this).html(a(this).attr("placeholder")),a(this).bind("focus",function(){""!==a(this).attr("placeholder")&&a(this).text()===a(this).attr("placeholder")&&(a(this).removeClass("placeholderText"),a(this).html(""))}),a(this).bind("blur",function(){""!==a(this).attr("placeholder")&&""===a(this).text()&&(a(this).addClass("placeholderText"),a(this).html(a(this).attr("placeholder")))})),f.dragAndDropImages&&t(),s(a(f.toolbarSelector),f),h.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){n(),j()}),a(window).bind("touchend",function(a){var b=h.is(a.target)||h.has(a.target).length>0,c=m(),d=c&&c.startContainer===c.endContainer&&c.startOffset===c.endOffset;(!d||b)&&(n(),j())}),this},a.fn.wysiwyg.defaults={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,fileUploadError:function(a,b){console.log("File upload error",a,b)}}}(window.jQuery);